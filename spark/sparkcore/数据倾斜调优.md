# ğŸ“– æ•°æ®å€¾æ–œ
## æ•°æ®å€¾æ–œå‘ç”Ÿçš„åŸç†
 - åœ¨è¿›è¡Œshuffleçš„æ—¶å€™ï¼Œå¿…é¡»å°†å„ä¸ªèŠ‚ç‚¹ä¸Šç›¸åŒçš„keyæ‹‰å–åˆ°æŸä¸ªèŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ªtaskæ¥è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚æŒ‰ç…§keyè¿›è¡Œèšåˆæˆ–joinç­‰æ“ä½œã€‚æ­¤æ—¶å¦‚æœæŸä¸ªkeyå¯¹åº”çš„æ•°æ®é‡ç‰¹åˆ«å¤§çš„è¯ï¼Œå°±ä¼šå‘ç”Ÿæ•°æ®å€¾æ–œã€‚
 - Sparkä½œä¸šçœ‹èµ·æ¥ä¼šè¿è¡Œå¾—éå¸¸ç¼“æ…¢ï¼Œç”šè‡³å¯èƒ½å› ä¸ºæŸä¸ªtaskå¤„ç†çš„æ•°æ®é‡è¿‡å¤§å¯¼è‡´å†…å­˜æº¢å‡º

## å®šä½é—®é¢˜
 - æ•°æ®å€¾æ–œåªä¼šå‘ç”Ÿåœ¨shuffleè¿‡ç¨‹ä¸­ã€‚ å¯èƒ½ä¼šè§¦å‘shuffleæ“ä½œçš„ç®—å­ï¼š`distinct`ã€`groupByKey`ã€`reduceByKey`ã€`aggregateByKey`ã€`join`ã€`cogroup`ã€`repartition`ç­‰ã€‚
 
### æŸä¸ªtaskæ‰§è¡Œç‰¹åˆ«æ…¢çš„æƒ…å†µ
### æŸä¸ªtaskè«åå…¶å¦™å†…å­˜æº¢å‡ºçš„æƒ…å†µ
     
   é€šè¿‡Spark Web UIæŸ¥çœ‹æŠ¥é”™çš„é‚£ä¸ªstageçš„å„ä¸ªtaskçš„è¿è¡Œæ—¶é—´ä»¥åŠåˆ†é…çš„æ•°æ®é‡
### æŸ¥çœ‹å¯¼è‡´æ•°æ®å€¾æ–œçš„keyçš„æ•°æ®åˆ†å¸ƒæƒ…å†µ, é‡‡æ ·
      ```scala
        val sampledPairs = pairs.sample(false, 0.1)
        val sampledWordCounts = sampledPairs.countByKey()
        sampledWordCounts.foreach(println(_))
     ```
## è§£å†³æ–¹æ¡ˆ
### 1. ä½¿ç”¨Hive ETLé¢„å¤„ç†æ•°æ®
     
      æ–¹æ¡ˆé€‚ç”¨åœºæ™¯ï¼šå¯¼è‡´æ•°æ®å€¾æ–œçš„æ˜¯Hiveè¡¨ã€‚
### 2. è¿‡æ»¤å°‘æ•°å¯¼è‡´å€¾æ–œçš„key
### 3. æé«˜shuffleæ“ä½œçš„å¹¶è¡Œåº¦
    
    å¢åŠ shuffle read taskçš„æ•°é‡ï¼Œåªèƒ½ç¼“è§£ã€‚è¿™ç§æ–¹æ¡ˆåªèƒ½è¯´æ˜¯åœ¨å‘ç°æ•°æ®å€¾æ–œæ—¶å°è¯•ä½¿ç”¨çš„ç¬¬ä¸€ç§æ‰‹æ®µï¼Œå°è¯•å»ç”¨ç®€å•çš„æ–¹æ³•ç¼“è§£æ•°æ®å€¾æ–œè€Œå·²ï¼Œæˆ–è€…æ˜¯å’Œå…¶ä»–æ–¹æ¡ˆç»“åˆèµ·æ¥ä½¿ç”¨
### 4. åˆ†ç»„èšåˆæ“ä½œ ä¸¤é˜¶æ®µèšåˆï¼ˆå±€éƒ¨èšåˆ+å…¨å±€èšåˆï¼‰
    ![img_3.png](img_3.png)
### 5. joinæ“ä½œ
   5.1. joinæ“ä½œä¸­çš„ä¸€ä¸ªRDDæˆ–è¡¨çš„æ•°æ®é‡æ¯”è¾ƒå°ï¼ˆæ¯”å¦‚å‡ ç™¾Mæˆ–è€…ä¸€ä¸¤Gï¼‰
      - å¹¿æ’­å°RDDå…¨é‡æ•°æ®+mapç®—å­
      - åªé€‚ç”¨äºä¸€ä¸ªå¤§è¡¨å’Œä¸€ä¸ªå°è¡¨çš„æƒ…å†µ
   
   ![img_5.png](img_5.png)
   
   ```scala
    // é¦–å…ˆå°†æ•°æ®é‡æ¯”è¾ƒå°çš„RDDçš„æ•°æ®ï¼Œcollectåˆ°Driverä¸­æ¥ã€‚
    List<Tuple2<Long, Row>> rdd1Data = rdd1.collect()
    // ç„¶åä½¿ç”¨Sparkçš„å¹¿æ’­åŠŸèƒ½ï¼Œå°†å°RDDçš„æ•°æ®è½¬æ¢æˆå¹¿æ’­å˜é‡ï¼Œè¿™æ ·æ¯ä¸ªExecutorå°±åªæœ‰ä¸€ä»½RDDçš„æ•°æ®ã€‚
    // å¯ä»¥å°½å¯èƒ½èŠ‚çœå†…å­˜ç©ºé—´ï¼Œå¹¶ä¸”å‡å°‘ç½‘ç»œä¼ è¾“æ€§èƒ½å¼€é”€ã€‚
    final Broadcast<List<Tuple2<Long, Row>>> rdd1DataBroadcast = sc.broadcast(rdd1Data);
      
    // å¯¹å¦å¤–ä¸€ä¸ªRDDæ‰§è¡Œmapç±»æ“ä½œï¼Œè€Œä¸å†æ˜¯joinç±»æ“ä½œã€‚
    JavaPairRDD<String, Tuple2<String, Row>> joinedRdd = rdd2.mapToPair(
            new PairFunction<Tuple2<Long,String>, String, Tuple2<String, Row>>() {
                private static final long serialVersionUID = 1L;
                @Override
                public Tuple2<String, Tuple2<String, Row>> call(Tuple2<Long, String> tuple)
                        throws Exception {
                    // åœ¨ç®—å­å‡½æ•°ä¸­ï¼Œé€šè¿‡å¹¿æ’­å˜é‡ï¼Œè·å–åˆ°æœ¬åœ°Executorä¸­çš„rdd1æ•°æ®ã€‚
                    List<Tuple2<Long, Row>> rdd1Data = rdd1DataBroadcast.value();
                    // å¯ä»¥å°†rdd1çš„æ•°æ®è½¬æ¢ä¸ºä¸€ä¸ªMapï¼Œä¾¿äºåé¢è¿›è¡Œjoinæ“ä½œã€‚
                    Map<Long, Row> rdd1DataMap = new HashMap<Long, Row>();
                    for(Tuple2<Long, Row> data : rdd1Data) {
                        rdd1DataMap.put(data._1, data._2);
                    }
                    // è·å–å½“å‰RDDæ•°æ®çš„keyä»¥åŠvalueã€‚
                    String key = tuple._1;
                    String value = tuple._2;
                    // ä»rdd1æ•°æ®Mapä¸­ï¼Œæ ¹æ®keyè·å–åˆ°å¯ä»¥joinåˆ°çš„æ•°æ®ã€‚
                    Row rdd1Value = rdd1DataMap.get(key);
                    return new Tuple2<String, String>(key, new Tuple2<String, Row>(value, rdd1Value));
                }
            });
      
    // è¿™é‡Œå¾—æç¤ºä¸€ä¸‹ã€‚
    // ä¸Šé¢çš„åšæ³•ï¼Œä»…ä»…é€‚ç”¨äºrdd1ä¸­çš„keyæ²¡æœ‰é‡å¤ï¼Œå…¨éƒ¨æ˜¯å”¯ä¸€çš„åœºæ™¯ã€‚
    // å¦‚æœrdd1ä¸­æœ‰å¤šä¸ªç›¸åŒçš„keyï¼Œé‚£ä¹ˆå°±å¾—ç”¨flatMapç±»çš„æ“ä½œï¼Œåœ¨è¿›è¡Œjoinçš„æ—¶å€™ä¸èƒ½ç”¨mapï¼Œè€Œæ˜¯å¾—éå†rdd1æ‰€æœ‰æ•°æ®è¿›è¡Œjoinã€‚
    // rdd2ä¸­æ¯æ¡æ•°æ®éƒ½å¯èƒ½ä¼šè¿”å›å¤šæ¡joinåçš„æ•°æ®ã€‚
   ```
   5.2. æ•°æ®å€¾æ–œçš„keyå°‘é‡ï¼š é‡‡æ ·å€¾æ–œkeyå¹¶åˆ†æ‹†joinæ“ä½œ,
     ![img_4.png](img_4.png)
     åŸç†ï¼šå¯¹äºjoinå¯¼è‡´çš„æ•°æ®å€¾æ–œï¼Œå¦‚æœåªæ˜¯æŸå‡ ä¸ªkeyå¯¼è‡´äº†å€¾æ–œï¼Œå¯ä»¥å°†å°‘æ•°å‡ ä¸ªkeyåˆ†æ‹†æˆç‹¬ç«‹RDDï¼Œå¹¶é™„åŠ éšæœºå‰ç¼€æ‰“æ•£æˆnä»½å»è¿›è¡Œjoinï¼Œæ­¤æ—¶è¿™å‡ ä¸ªkeyå¯¹åº”çš„æ•°æ®å°±ä¸ä¼šé›†ä¸­åœ¨å°‘æ•°å‡ ä¸ªtaskä¸Šï¼Œè€Œæ˜¯åˆ†æ•£åˆ°å¤šä¸ªtaskè¿›è¡Œjoinäº†
     ç¼ºç‚¹ï¼šå¦‚æœå¯¼è‡´å€¾æ–œçš„keyç‰¹åˆ«å¤šçš„è¯ï¼Œæ¯”å¦‚æˆåƒä¸Šä¸‡ä¸ªkeyéƒ½å¯¼è‡´æ•°æ®å€¾æ–œï¼Œé‚£ä¹ˆè¿™ç§æ–¹å¼ä¹Ÿä¸é€‚åˆã€‚
   
   ```scala
       // é¦–å…ˆä»åŒ…å«äº†å°‘æ•°å‡ ä¸ªå¯¼è‡´æ•°æ®å€¾æ–œkeyçš„rdd1ä¸­ï¼Œé‡‡æ ·10%çš„æ ·æœ¬æ•°æ®ã€‚
        JavaPairRDD<Long, String> sampledRDD = rdd1.sample(false, 0.1);
          
        // å¯¹æ ·æœ¬æ•°æ®RDDç»Ÿè®¡å‡ºæ¯ä¸ªkeyçš„å‡ºç°æ¬¡æ•°ï¼Œå¹¶æŒ‰å‡ºç°æ¬¡æ•°é™åºæ’åºã€‚
        // å¯¹é™åºæ’åºåçš„æ•°æ®ï¼Œå–å‡ºtop 1æˆ–è€…top 100çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯keyæœ€å¤šçš„å‰nä¸ªæ•°æ®ã€‚
        // å…·ä½“å–å‡ºå¤šå°‘ä¸ªæ•°æ®é‡æœ€å¤šçš„keyï¼Œç”±å¤§å®¶è‡ªå·±å†³å®šï¼Œæˆ‘ä»¬è¿™é‡Œå°±å–1ä¸ªä½œä¸ºç¤ºèŒƒã€‚
        JavaPairRDD<Long, Long> mappedSampledRDD = sampledRDD.mapToPair(
                new PairFunction<Tuple2<Long,String>, Long, Long>() {
                    private static final long serialVersionUID = 1L;
                    @Override
                    public Tuple2<Long, Long> call(Tuple2<Long, String> tuple)
                            throws Exception {
                        return new Tuple2<Long, Long>(tuple._1, 1L);
                    }     
                });
        JavaPairRDD<Long, Long> countedSampledRDD = mappedSampledRDD.reduceByKey(
                new Function2<Long, Long, Long>() {
                    private static final long serialVersionUID = 1L;
                    @Override
                    public Long call(Long v1, Long v2) throws Exception {
                        return v1 + v2;
                    }
                });
        JavaPairRDD<Long, Long> reversedSampledRDD = countedSampledRDD.mapToPair( 
                new PairFunction<Tuple2<Long,Long>, Long, Long>() {
                    private static final long serialVersionUID = 1L;
                    @Override
                    public Tuple2<Long, Long> call(Tuple2<Long, Long> tuple)
                            throws Exception {
                        return new Tuple2<Long, Long>(tuple._2, tuple._1);
                    }
                });
        final Long skewedUserid = reversedSampledRDD.sortByKey(false).take(1).get(0)._2;
          
        // ä»rdd1ä¸­åˆ†æ‹†å‡ºå¯¼è‡´æ•°æ®å€¾æ–œçš„keyï¼Œå½¢æˆç‹¬ç«‹çš„RDDã€‚
        JavaPairRDD<Long, String> skewedRDD = rdd1.filter(
                new Function<Tuple2<Long,String>, Boolean>() {
                    private static final long serialVersionUID = 1L;
                    @Override
                    public Boolean call(Tuple2<Long, String> tuple) throws Exception {
                        return tuple._1.equals(skewedUserid);
                    }
                });
        // ä»rdd1ä¸­åˆ†æ‹†å‡ºä¸å¯¼è‡´æ•°æ®å€¾æ–œçš„æ™®é€škeyï¼Œå½¢æˆç‹¬ç«‹çš„RDDã€‚
        JavaPairRDD<Long, String> commonRDD = rdd1.filter(
                new Function<Tuple2<Long,String>, Boolean>() {
                    private static final long serialVersionUID = 1L;
                    @Override
                    public Boolean call(Tuple2<Long, String> tuple) throws Exception {
                        return !tuple._1.equals(skewedUserid);
                    } 
                });
          
        // rdd2ï¼Œå°±æ˜¯é‚£ä¸ªæ‰€æœ‰keyçš„åˆ†å¸ƒç›¸å¯¹è¾ƒä¸ºå‡åŒ€çš„rddã€‚
        // è¿™é‡Œå°†rdd2ä¸­ï¼Œå‰é¢è·å–åˆ°çš„keyå¯¹åº”çš„æ•°æ®ï¼Œè¿‡æ»¤å‡ºæ¥ï¼Œåˆ†æ‹†æˆå•ç‹¬çš„rddï¼Œå¹¶å¯¹rddä¸­çš„æ•°æ®ä½¿ç”¨flatMapç®—å­éƒ½æ‰©å®¹100å€ã€‚
        // å¯¹æ‰©å®¹çš„æ¯æ¡æ•°æ®ï¼Œéƒ½æ‰“ä¸Š0ï½100çš„å‰ç¼€ã€‚
        JavaPairRDD<String, Row> skewedRdd2 = rdd2.filter(
                 new Function<Tuple2<Long,Row>, Boolean>() {
                    private static final long serialVersionUID = 1L;
                    @Override
                    public Boolean call(Tuple2<Long, Row> tuple) throws Exception {
                        return tuple._1.equals(skewedUserid);
                    }
                }).flatMapToPair(new PairFlatMapFunction<Tuple2<Long,Row>, String, Row>() {
                    private static final long serialVersionUID = 1L;
                    @Override
                    public Iterable<Tuple2<String, Row>> call(
                            Tuple2<Long, Row> tuple) throws Exception {
                        Random random = new Random();
                        List<Tuple2<String, Row>> list = new ArrayList<Tuple2<String, Row>>();
                        for(int i = 0; i < 100; i++) {
                            list.add(new Tuple2<String, Row>(i + "_" + tuple._1, tuple._2));
                        }
                        return list;
                    }
                      
                });
         
        // å°†rdd1ä¸­åˆ†æ‹†å‡ºæ¥çš„å¯¼è‡´å€¾æ–œçš„keyçš„ç‹¬ç«‹rddï¼Œæ¯æ¡æ•°æ®éƒ½æ‰“ä¸Š100ä»¥å†…çš„éšæœºå‰ç¼€ã€‚
        // ç„¶åå°†è¿™ä¸ªrdd1ä¸­åˆ†æ‹†å‡ºæ¥çš„ç‹¬ç«‹rddï¼Œä¸ä¸Šé¢rdd2ä¸­åˆ†æ‹†å‡ºæ¥çš„ç‹¬ç«‹rddï¼Œè¿›è¡Œjoinã€‚
        JavaPairRDD<Long, Tuple2<String, Row>> joinedRDD1 = skewedRDD.mapToPair(
                new PairFunction<Tuple2<Long,String>, String, String>() {
                    private static final long serialVersionUID = 1L;
                    @Override
                    public Tuple2<String, String> call(Tuple2<Long, String> tuple)
                            throws Exception {
                        Random random = new Random();
                        int prefix = random.nextInt(100);
                        return new Tuple2<String, String>(prefix + "_" + tuple._1, tuple._2);
                    }
                })
                .join(skewedUserid2infoRDD)
                .mapToPair(new PairFunction<Tuple2<String,Tuple2<String,Row>>, Long, Tuple2<String, Row>>() {
                                private static final long serialVersionUID = 1L;
                                @Override
                                public Tuple2<Long, Tuple2<String, Row>> call(
                                    Tuple2<String, Tuple2<String, Row>> tuple)
                                    throws Exception {
                                    long key = Long.valueOf(tuple._1.split("_")[1]);
                                    return new Tuple2<Long, Tuple2<String, Row>>(key, tuple._2);
                                }
                            });
         
        // å°†rdd1ä¸­åˆ†æ‹†å‡ºæ¥çš„åŒ…å«æ™®é€škeyçš„ç‹¬ç«‹rddï¼Œç›´æ¥ä¸rdd2è¿›è¡Œjoinã€‚
        JavaPairRDD<Long, Tuple2<String, Row>> joinedRDD2 = commonRDD.join(rdd2);
         
        // å°†å€¾æ–œkey joinåçš„ç»“æœä¸æ™®é€škey joinåçš„ç»“æœï¼Œuinonèµ·æ¥ã€‚
        // å°±æ˜¯æœ€ç»ˆçš„joinç»“æœã€‚
        JavaPairRDD<Long, Tuple2<String, Row>> joinedRDD = joinedRDD1.union(joinedRDD2);
   ```
   
   
  5.3 æœ‰å¤§é‡çš„keyå¯¼è‡´æ•°æ®å€¾æ–œ: ä½¿ç”¨éšæœºå‰ç¼€å’Œæ‰©å®¹RDDè¿›è¡Œjoin
   
       éœ€è¦å¯¹æ•´ä¸ªRDDè¿›è¡Œæ‰©å®¹ï¼Œå¯¹å†…å­˜èµ„æºè¦æ±‚å¾ˆé«˜
    ```scala
        // é¦–å…ˆå°†å…¶ä¸­ä¸€ä¸ªkeyåˆ†å¸ƒç›¸å¯¹è¾ƒä¸ºå‡åŒ€çš„RDDè†¨èƒ€100å€ã€‚
        JavaPairRDD<String, Row> expandedRDD = rdd1.flatMapToPair(
        new PairFlatMapFunction<Tuple2<Long,Row>, String, Row>() {
            private static final long serialVersionUID = 1L;
            @Override
            public Iterable<Tuple2<String, Row>> call(Tuple2<Long, Row> tuple)
                    throws Exception {
                List<Tuple2<String, Row>> list = new ArrayList<Tuple2<String, Row>>();
                for(int i = 0; i < 100; i++) {
                    list.add(new Tuple2<String, Row>(0 + "_" + tuple._1, tuple._2));
                }
                return list;
            }
        });
    // å…¶æ¬¡ï¼Œå°†å¦ä¸€ä¸ªæœ‰æ•°æ®å€¾æ–œkeyçš„RDDï¼Œæ¯æ¡æ•°æ®éƒ½æ‰“ä¸Š100ä»¥å†…çš„éšæœºå‰ç¼€ã€‚
    JavaPairRDD<String, String> mappedRDD = rdd2.mapToPair(
            new PairFunction<Tuple2<Long,String>, String, String>() {
                private static final long serialVersionUID = 1L;
                @Override
                public Tuple2<String, String> call(Tuple2<Long, String> tuple)
                        throws Exception {
                    Random random = new Random();
                    int prefix = random.nextInt(100);
                    return new Tuple2<String, String>(prefix + "_" + tuple._1, tuple._2);
                }
            });
      
    // å°†ä¸¤ä¸ªå¤„ç†åçš„RDDè¿›è¡Œjoinå³å¯ã€‚
    JavaPairRDD<String, Tuple2<String, Row>> joinedRDD = mappedRDD.join(expandedRDD);
    ```

  - vs:
   æ–¹æ¡ˆä¸€ å°†rdd1ä¸­åˆ†æ‹†å‡ºæ¥çš„å¯¼è‡´å€¾æ–œçš„keyçš„ç‹¬ç«‹rddï¼Œæ¯æ¡æ•°æ®éƒ½æ‰“ä¸Š100ä»¥å†…çš„éšæœºå‰ç¼€ã€‚
   æ–¹æ¡ˆäºŒ å¯¹æ•´ä¸ªRDDè¿›è¡Œæ‰©å®¹
### 6. å¤šç§æ–¹æ¡ˆç»„åˆä½¿ç”¨
